<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: gitlab | CodeBean]]></title>
  <link href="http://sailxjx.github.com/blog/blog/categories/gitlab/atom.xml" rel="self"/>
  <link href="http://sailxjx.github.com/blog/"/>
  <updated>2013-03-09T15:55:32+08:00</updated>
  <id>http://sailxjx.github.com/blog/</id>
  <author>
    <name><![CDATA[tristan]]></name>
    <email><![CDATA[sailxjx@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[gitlabhq 部署小记]]></title>
    <link href="http://sailxjx.github.com/blog/blog/2012/11/14/gitlabhq-bu-shu-xiao-ji/"/>
    <updated>2012-11-14T20:12:00+08:00</updated>
    <id>http://sailxjx.github.com/blog/blog/2012/11/14/gitlabhq-bu-shu-xiao-ji</id>
    <content type="html"><![CDATA[<p>冬天来了，不知github是不是也去冬眠了，速度慢的像在爬，没办法，屌丝买不起vps，只能自己内网部一套开源的。</p>

<p>gitlabhq是github的一个开源版本，虽然不是官方的，但是已经做的有模有样，总之能想到的功能都已具备，放在国内随便改改UI就能上线建站的那种。安装文档那是写的相当滴详细，体现了码农罕有的耐性，查看文档请移步<a href="https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/installation.md">gitlab文档</a></p>

<p>以前部署中在ssh上碰到一些问题，这次在<a href="https://github.com/mk-qi">@mk-qi</a>童鞋的点拨下，进展是相当滴顺利，下面记录一些部署过程中的问题和解决方法。</p>

<p>自动部署脚本如下，基本由文档转成，可以省掉很多事情(但是遇到问题要学会google哦)，假如使用的是ubuntu，官方以前也提供了一个一键安装脚本，后来不知怎么又去掉了，估计是计划赶不上变化吧</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>gitlabhq自动化部署脚本  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;!/bin/bash&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;add user git&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;sudo adduser --system --shell /bin/bash --gecos <span class="s1">&#39;git version control&#39;</span> --group --disabled-password --home /home/git git&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;add user gitlab&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;sudo adduser --disabled-login --gecos <span class="s1">&#39;gitlab system&#39;</span> gitlab&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;move user gitlab to group git&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;sudo usermod -a -G git gitlab
</span><span class='line'>sudo usermod -a -G gitlab git&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;generate key&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;sudo -H -u gitlab ssh-keygen -q -N <span class="s1">&#39;&#39;</span> -t rsa -f /home/gitlab/.ssh/id_rsa&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;clone gitlab<span class="s1">&#39;s fork to the gitolite source code&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;p&gt;cd /home/git</span>
</span><span class='line'><span class="s1">sudo -H -u git git clone -b gl-v304 https://github.com/gitlabhq/gitolite.git /home/git/gitolite&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;h1&gt;setup&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;p&gt;cd /home/git</span>
</span><span class='line'><span class="s1">sudo -u git -H mkdir bin</span>
</span><span class='line'><span class="s1">sudo -u git sh -c &#39;</span><span class="nb">echo</span> -e <span class="s2">&quot;PATH=\$PATH:/home/git/bin\nexport PATH&quot;</span> &gt;&gt; /home/git/.profile<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">sudo -u git sh -c &#39;</span>gitolite/install -ln /home/git/bin<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">sudo cp /home/gitlab/.ssh/id_rsa.pub /home/git/gitlab.pub</span>
</span><span class='line'><span class="s1">sudo chmod 0444 /home/git/gitlab.pub</span>
</span><span class='line'><span class="s1">sudo -u git -H sh -c &quot;PATH=/home/git/bin:$PATH; gitolite setup -pk /home/git/gitlab.pub&quot;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;h1&gt;permissions&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;p&gt;sudo chmod -R g+rwX /home/git/repositories/</span>
</span><span class='line'><span class="s1">sudo chown -R git:git /home/git/repositories/</span>
</span><span class='line'><span class="s1">sudo -u gitlab -H git clone git@localhost:gitolite-admin.git /tmp/gitolite-admin&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;p&gt;if [[ $? != 0 ]];then&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;pre&gt;&lt;code&gt;echo &quot;error: gitolite is not installed correct, or the ssh key is not right&quot;</span>
</span><span class='line'><span class="s1">exit 1</span>
</span><span class='line'><span class="s1">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;p&gt;fi&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;p&gt;sudo rm -rf /tmp/gitolite-admin&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;h1&gt;clone gitlab source and install prerequisites&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;p&gt;sudo gem install charlock_holmes</span>
</span><span class='line'><span class="s1">sudo pip install pygments</span>
</span><span class='line'><span class="s1">cd /home/gitlab</span>
</span><span class='line'><span class="s1">sudo -H -u gitlab git clone git://github.com/51fanli/gitlabhq.git gitlab</span>
</span><span class='line'><span class="s1">cd gitlab</span>
</span><span class='line'><span class="s1">sudo -u gitlab cp config/gitlab.yml.example config/gitlab.yml&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;h1&gt;mysql databases init&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;p&gt;echo &quot;connect to mysql&quot;</span>
</span><span class='line'><span class="s1">mysql -h127.0.0.1 -uroot -p&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;h1&gt;CREATE DATABASE IF NOT EXISTS &lt;code&gt;gitlabhq_production&lt;/code&gt; DEFAULT CHARACTER SET &lt;code&gt;utf8&lt;/code&gt; COLLATE &lt;code&gt;utf8_unicode_ci&lt;/code&gt;;&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;h1&gt;CREATE USER &#39;</span>gitlab<span class="s1">&#39;@&#39;</span>localhost<span class="s1">&#39; IDENTIFIED BY &#39;</span>123456<span class="s1">&#39;;&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&lt;h1&gt;GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON &lt;code&gt;gitlabhq_production&lt;/code&gt;.* TO &#39;</span>gitlab<span class="s1">&#39;@&#39;</span>localhost<span class="err">&#39;</span>;&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;sudo -u gitlab cp config/database.yml.example config/database.yml
</span><span class='line'>sudo -u gitlab -H bundle install --without development <span class="nb">test </span>sqlite postgres --deployment
</span><span class='line'>sudo -u gitlab -H git config --global user.email <span class="s2">&quot;gitlab@localhost&quot;</span>
</span><span class='line'>sudo -u gitlab -H git config --global user.name <span class="s2">&quot;Gitlab&quot;</span>
</span><span class='line'>sudo -u gitlab cp config/resque.yml.example config/resque.yml
</span><span class='line'>sudo -u gitlab cp config/unicorn.rb.example config/unicorn.rb&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;init tables&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;sudo -u gitlab bundle <span class="nb">exec </span>rake gitlab:app:setup <span class="nv">RAILS_ENV</span><span class="o">=</span>production
</span><span class='line'>sudo cp ./lib/hooks/post-receive /home/git/.gitolite/hooks/common/post-receive
</span><span class='line'>sudo chown git:git /home/git/.gitolite/hooks/common/post-receive&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;check status&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;sudo -u gitlab bundle <span class="nb">exec </span>rake gitlab:app:status <span class="nv">RAILS_ENV</span><span class="o">=</span>production
</span><span class='line'>sudo wget https://raw.github.com/gitlabhq/gitlab-recipes/master/init.d/gitlab -P /etc/init.d/
</span><span class='line'>sudo chmod +x /etc/init.d/gitlab
</span><span class='line'>sudo update-rc.d gitlab defaults 21
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>gitlabhq3.0后改用unicorn(紧跟github步伐)作为默认的启动server,要将它与nginx或apache一起使用请参考<a href="https://wiki.archlinux.org/index.php/Gitlab#Web_server_configuration">archwiki的gitlab手册</a>,下面是apache中的vhost配置(需要预先编译proxy模块)</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>apache vhost配置  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;VirtualHost *:80&gt;
</span><span class='line'>  ServerName gitlab.myserver.com
</span><span class='line'>  ServerAlias www.gitlab.myserver.com
</span><span class='line'>  DocumentRoot /home/gitlab/gitlab/public
</span><span class='line'>  ErrorLog /var/log/httpd/gitlab_error_log
</span><span class='line'>  CustomLog /var/log/httpd/gitlab_access_log combined&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  &lt;Proxy balancer://unicornservers&gt;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;  BalancerMember http://127.0.0.1:8080
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  &lt;/Proxy&gt;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  &lt;Directory /home/gitlab/gitlab/public&gt;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;AllowOverride All
</span><span class='line'>Options -MultiViews
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  &lt;/Directory&gt;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  RewriteEngine on
</span><span class='line'>  RewriteCond %<span class="o">{</span>DOCUMENT_ROOT<span class="o">}</span>/%<span class="o">{</span>REQUEST_FILENAME<span class="o">}</span> !-f
</span><span class='line'>  RewriteRule ^/<span class="o">(</span>.*<span class="o">)</span><span class="nv">$ </span>balancer://unicornservers%<span class="o">{</span>REQUEST_URI<span class="o">}</span> <span class="o">[</span>P,QSA,L<span class="o">]</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  ProxyPass /uploads !
</span><span class='line'>  ProxyPass / balancer://unicornservers/
</span><span class='line'>  ProxyPassReverse / balancer://unicornservers/
</span><span class='line'>  ProxyPreserveHost on&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;   &lt;Proxy *&gt;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;  Order deny,allow
</span><span class='line'>  Allow from all
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;   &lt;/Proxy&gt;
</span><span class='line'>&lt;/VirtualHost&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>unicorn的配置文件在config/unicorn.rb，修改其中的 <code>listen="127.0.0.1:8080"</code>，然后重启apache，通过 <code>service gitlab start</code> 重启unicorn，访问一下gitlab.myserver.com吧，看到登录页面就说明大功告成啦。</p>

<h2>Q&amp;A</h2>

<h3>Q: 在装完gitolite后尝试<code>git clone git@localhost:gitolite-admin.git /tmp/gitolite-admin</code>遇到'remote hang-up unexpected'(貌似是这么写，意会。。。)</h3>

<p>A: 我在centos6.2上遇到过这个问题，其他发行版上不知道有没有这个问题，修改</p>

<p><code>sudo chmod 400 /home/git/.ssh/authorized_keys</code></p>

<p>可以修复这个问题。貌似是centos的安全策略造成ssh私钥不生效</p>

<h2>参考资料</h2>

<ul>
<li><a href="https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/installation.md">gitlab安装手册官方版</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Gitlab">gitlab手册archwiki版</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
