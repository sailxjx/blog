
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>CodeBean</title>
	<meta name="author" content="Xu Jingxin">

	
	<meta name="description" content="最近好像有款叫 Soylent 的食物（？）突然在网上流行起来，到哪儿都能看到有人推荐这款产品。保守如我，在心理上实在接受不了每天就靠喝这种芝麻糊过日子。 什么时候吃饭变成了一件麻烦事 生活节奏越来越快，我已经不记得上次做饭是什么时候了。我倒是不太排斥烧菜的过程，真正的麻烦都在准备食材的阶段， &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/blog/atom.xml" rel="alternate" title="CodeBean" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/blog/favicon.ico" rel="shortcut icon">
	<link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/blog/">CodeBean</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/blog/">Blog</a></li>
	<li><a href="/blog/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/blog/">Blog</a></li>
	<li><a href="/blog/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:jingxin.me/blog">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		<a class="google" href="https://plus.google.com/102588932744890343699?rel=author" title="Google+">Google+</a>
		
		
		
		<a class="github" href="https://github.com/sailxjx" title="GitHub">GitHub</a>
		
		
		
		
		
		<a class="rss" href="/blog/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:jingxin.me/blog">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h1 class="title"><a href="/blog/blog/2015/07/26/guan-yu-chi-fan/">关于吃饭</a></h1>
	<div class="entry-content">
		<p>最近好像有款叫 Soylent 的食物（？）突然在网上流行起来，到哪儿都能看到有人推荐这款产品。保守如我，在心理上实在接受不了每天就靠喝这种芝麻糊过日子。</p>

<h2 id="section">什么时候吃饭变成了一件麻烦事</h2>

<p>生活节奏越来越快，我已经不记得上次做饭是什么时候了。我倒是不太排斥烧菜的过程，真正的麻烦都在准备食材的阶段，如果手边有现成洗净的食材，我是很愿意煎炒蒸煮一下的。在身体健康的年纪，吃遍天下美食应该是一种美好的享受吧，食物和调料带来的快乐可不是一大杯蛋白质糊可以比拟的。</p>

<p>就算在快节奏的工作日，吃一顿饭也占用不了太多的时间。Soylent 貌似并不比去路边吃顿饭更省事，如果专为懒人设计，我建议他们将冲泡壶设计成一次性的，吃完就丢，岂不更方便。</p>

<h2 id="section-1">吃饭真的只是为了饱腹吗</h2>

<p>吃饭也是一种社交活动，吃饭的时候和别人聊聊热门话题，开拓一下视野，转移一下注意力，既是休息，也是增进了解的一种方式。大家围成一桌喝着芝麻糊聊天的场景，画面太美，实在不敢想想。</p>

<p>不过这年头新产品和新概念层出不穷，不断刷新人们的世界观，出现 Soylent，也算是科技和互联网发展的一种副产品。也许以后该转换一下思路，能保持独立思考，同时接受新事物。</p>

<p>为了这个写一篇文章确实慢蛋疼的，晚饭加个蛋压压惊。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-07-26T18:00:00+08:00" pubdate data-updated="true">2015.07.26</time></div>
	<div class="tags">


	<a class='category' href='/blog/blog/categories/caprice/'>caprice</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/blog/2015/06/18/node-dot-js-sha-he/">Node.js 沙盒</a></h1>
	<div class="entry-content">
		<h2 id="section">为什么要使用沙盒</h2>

<p>eval 在很多语言中都是一个很有用的方法，合理利用它可以编写出很多让人拍案叫绝的功能。但是由于它实在过于开放和危险，很多人给它冠上了 <strong>evil</strong> 的称号。</p>

<p>使用沙盒可以给 eval 类的功能增加一些条件限制，让它变得更加安全，而不丢失其灵活性。</p>

<p>Node.js 中提供的 vm 模块可以轻松实现沙盒的功能。</p>

<h2 id="vm-">如何使用 vm 模块</h2>

<h3 id="vmruninthiscontext"><code>vm.runInThisContext</code></h3>

<p><code>vm.runInThisContext</code> 可以执行代码并得到它的返回值，被执行的代码没有权限访问本地对象，但是可以访问全局对象。相比之下， eval 则有权限访问上下文中的对象。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kd">var</span> <span class="nx">localVar</span> <span class="o">=</span> <span class="s1">&#39;initial value&#39;</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="kd">var</span> <span class="nx">vmResult</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInThisContext</span><span class="p">(</span><span class="s1">&#39;localVar = &quot;vm&quot;;&#39;</span><span class="p">);</span>
</span><span class="line"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;vmResult: &#39;</span><span class="p">,</span> <span class="nx">vmResult</span><span class="p">);</span>
</span><span class="line"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;localVar: &#39;</span><span class="p">,</span> <span class="nx">localVar</span><span class="p">);</span>
</span><span class="line">
</span><span class="line"><span class="kd">var</span> <span class="nx">evalResult</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;localVar = &quot;eval&quot;;&#39;</span><span class="p">);</span>
</span><span class="line"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;evalResult: &#39;</span><span class="p">,</span> <span class="nx">evalResult</span><span class="p">);</span>
</span><span class="line"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;localVar: &#39;</span><span class="p">,</span> <span class="nx">localVar</span><span class="p">);</span>
</span><span class="line">
</span><span class="line"><span class="c1">// vmResult: &#39;vm&#39;, localVar: &#39;initial value&#39;</span>
</span><span class="line"><span class="c1">// evalResult: &#39;eval&#39;, localVar: &#39;eval&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="vmcreatecontext--vmrunincontext"><code>vm.createContext</code> 与 <code>vm.runInContext</code></h3>

<p><code>vm.createContext</code> 则是真正创造了一个沙盒对象，使用 <code>vm.runInContext</code> 可以完全让代码在这个沙盒环境中运行。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">);</span>
</span><span class="line"><span class="kd">var</span> <span class="nx">vm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;vm&#39;</span><span class="p">);</span>
</span><span class="line">
</span><span class="line"><span class="nx">sandbox</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">createContext</span><span class="p">({</span> <span class="nx">globalVar</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span>
</span><span class="line">
</span><span class="line"><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">vm</span><span class="p">.</span><span class="nx">runInContext</span><span class="p">(</span><span class="s1">&#39;globalVar *= 2;&#39;</span><span class="p">,</span> <span class="nx">sandbox</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(</span><span class="nx">sandbox</span><span class="p">));</span>
</span><span class="line"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">globalVar</span><span class="p">);</span>
</span><span class="line">
</span><span class="line"><span class="c1">// { globalVar: 1024 }</span>
</span><span class="line"><span class="c1">// undefined</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="vm--1">vm 的具体应用</h2>

<p><a href="https://github.com/teambition/configd"><code>configd</code></a> 是我为公司部署流程开发的一个小工具，功能是将各种来源的配置文件合并成一个 json 文件。由于它支持 <code>ssh</code>, <code>git</code>, <code>http</code> 等多种来源的配置或代码，所以需要在工具内部来执行这些代码以实现和本地 <code>require</code> 类似的效果。如果用 <code>eval</code>，那么除却风险问题，<code>module.exports</code> 也不能生效了。所以在工具中使用了 vm 模块来执行这些代码。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nv">_eval = </span><span class="nf">(js, options = {}) -&gt;</span>
</span><span class="line">  <span class="nv">sandbox = </span><span class="nx">vm</span><span class="p">.</span><span class="nx">createContext</span><span class="p">()</span>
</span><span class="line">  <span class="nv">sandbox.exports = </span><span class="nx">exports</span>
</span><span class="line">  <span class="nv">sandbox.module = exports: </span><span class="nx">exports</span>
</span><span class="line">  <span class="nv">sandbox.global = </span><span class="nx">sandbox</span>
</span><span class="line">  <span class="nv">sandbox.require = </span><span class="nx">require</span>
</span><span class="line">  <span class="nv">sandbox.__filename = </span><span class="nx">options</span><span class="p">.</span><span class="nx">filename</span> <span class="o">or</span> <span class="s">&#39;eval&#39;</span>
</span><span class="line">  <span class="nv">sandbox.__dirname = </span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span> <span class="nx">sandbox</span><span class="p">.</span><span class="nx">__filename</span>
</span><span class="line">
</span><span class="line">  <span class="nx">vm</span><span class="p">.</span><span class="nx">runInContext</span> <span class="nx">js</span><span class="p">,</span> <span class="nx">sandbox</span>
</span><span class="line">
</span><span class="line">  <span class="nx">sandbox</span><span class="p">.</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span>
</span><span class="line">
</span><span class="line"><span class="nv">data = </span><span class="nx">_eval</span> <span class="nx">js</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="section-1">参考资料</h2>

<p><a href="https://nodejs.org/api/vm.html">Executing JavaScript</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-18T16:36:00+08:00" pubdate data-updated="true">2015.06.18</time></div>
	<div class="tags">


	<a class='category' href='/blog/blog/categories/nodejs/'>nodejs</a>, <a class='category' href='/blog/blog/categories/sandbox/'>sandbox</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/blog/2015/04/30/what-is-ncr/">NCR 是什么</a></h1>
	<div class="entry-content">
		<p>一直以来，对爬虫抓取的某些内容感到很费解，比如形似 <code>&amp;#x4e2d;&amp;#x56fd;</code> 的字符串，最初以为是经过编码的 unicode 字符，但是尝试了各种手段都无法解开。最近开始关注起这个问题，机缘巧合在知乎上搜到了<a href="http://www.zhihu.com/question/21390312">一个回答</a>，原来这些是叫做 <a href="http://en.wikipedia.org/wiki/Numeric_character_reference">numeric character reference (NCR)</a> 的转义序列，在这里记录一下，权作备忘。</p>

<p>以下一段引用自知乎梁海的<a href="http://www.zhihu.com/question/21390312/answer/18091465">回答</a>：</p>

<blockquote>
  <p>形如 ——</p>

  <p><code>&amp;#dddd;</code></p>

  <p><code>&amp;#xhhhh;</code></p>

  <p><code>&amp;#name;</code></p>

  <p>—— 的一串字符是 HTML、XML 等 SGML 类语言的转义序列（escape sequence）。它们不是「编码」。</p>

  <p>以 HTML 为例，这三种转义序列都称作 character reference：</p>

  <p>前两种是 numeric character reference（NCR），数字取值为目标字符的 Unicode code point；以「&amp;#」开头的后接十进制数字，以「&amp;#x」开头的后接十六进制数字。
后一种是 character entity reference，后接预先定义的 entity 名称，而 entity 声明了自身指代的字符。</p>

  <p>从 HTML 4 开始，NCR 以 Unicode 为准，与文档编码无关。</p>

  <p>「中国」二字分别是 Unicode 字符 U+4E2D 和 U+56FD，十六进制表示的 code point 数值「4E2D」和「56FD」就是十进制的「20013」和「22269」。所以 ——</p>

  <p><code>&amp;#x4e2d;&amp;#x56fd;</code></p>

  <p><code>&amp;#20013;&amp;#22269;</code></p>

  <p>—— 这两种 NCR 写法都会在显示时转换为「中国」二字。</p>
</blockquote>

<p>至于怎么去 <code>encode/decode</code> 这些字符，在网上找到了一个简单的 <a href="http://snipplr.com/view/772/encode-numeric-character-reference/"><code>Javascript</code> 版本</a>：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ncr2c</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="k">return</span> <span class="k">this</span>
</span><span class="line">    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="sr">/&amp;#x([\da-f]{2,4});/gi</span><span class="p">,</span>
</span><span class="line">    <span class="kd">function</span><span class="p">(</span> <span class="nx">$0</span><span class="p">,</span> <span class="nx">$1</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span> <span class="s2">&quot;0x&quot;</span> <span class="o">+</span> <span class="nx">$1</span> <span class="p">)</span> <span class="p">}</span> <span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">c2ncr</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="k">return</span> <span class="k">this</span> <span class="p">.</span><span class="nx">ncr2c</span><span class="p">(</span> <span class="p">).</span><span class="nx">replace</span><span class="p">(</span> <span class="sr">/./g</span><span class="p">,</span>
</span><span class="line">    <span class="kd">function</span><span class="p">(</span> <span class="nx">$0</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;&amp;#x&quot;</span> <span class="o">+</span> <span class="nx">$0</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span> <span class="p">).</span><span class="nx">toString</span><span class="p">(</span> <span class="mi">16</span> <span class="p">).</span><span class="nx">toUpperCase</span><span class="p">(</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span> <span class="p">}</span> <span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="nx">alert</span><span class="p">(</span> <span class="s2">&quot;&amp;#x61;&amp;#x6A;&amp;#x61;&amp;#x78;&quot;</span><span class="p">.</span><span class="nx">ncr2c</span><span class="p">(</span> <span class="p">)</span> <span class="p">);</span>
</span><span class="line"><span class="c1">//ajax</span>
</span><span class="line">
</span><span class="line"><span class="nx">alert</span><span class="p">(</span> <span class="s2">&quot;a&amp;#x6A;ax&quot;</span><span class="p">.</span><span class="nx">c2ncr</span><span class="p">(</span> <span class="p">)</span> <span class="p">);</span>
</span><span class="line"><span class="c1">//&amp;#x61;&amp;#x6A;&amp;#x61;&amp;#x78;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>由于上面的方案是以修改 String 原型来实现的（一般不认为这是一个好做法），使用的时候可以改成两个方法。</p>

<p>而另一种更 robust 的方案则是使用第三方库，例如 <a href="https://github.com/mathiasbynens/he"><code>he</code> 模块</a>，轻松实现对很多转义序列的支持。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-04-30T09:45:00+08:00" pubdate data-updated="true">2015.04.30</time></div>
	<div class="tags">


	<a class='category' href='/blog/blog/categories/html/'>html</a>, <a class='category' href='/blog/blog/categories/ncr/'>ncr</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/blog/2014/12/21/multipart-dao-di-shi-ge-sha-wan-yi-er/">Multipart 到底是个啥玩意儿</a></h1>
	<div class="entry-content">
		<p>在 POST 请求中，常见的几种请求头有 ‘application/x-www-form-urlencoded’， ‘application/json’，这些都很容易理解，唯独 ‘multipart/form-data’ 这种请求挺让我费解，下面就来详细说明一下，以作笔记备查。</p>

<p>在 GET 请求中，参数一般会以 ‘&amp;’ 为分割符号，比如 ‘http://api.example.com?name=tom&amp;friend=jerry’，在 ‘application/x-www-form-urlencoded’ 类的 POST 请求中，参数形式与此类似，只不过参数被写在了 body 中，以突破 url 中 2k 字节的限制。</p>

<p>而当我们想上传文件或其他二进制数据时，根据 form 标准，非字符串会被替换成 ‘%HH’，其中的 ‘HH’ 是两个十六进制数来表示当前这位的二进制数据。在上传大文件的时候，这种做法就显得非常浪费了。于是，我们经常会把 ‘multipart/form-data’ 来用在文件上传中。</p>

<p>我们来看一个完整的 ‘multipart/form-data’ 请求：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class=""><span class="line">Content-Type: multipart/form-data; boundary=AaB03x
</span><span class="line">
</span><span class="line">--AaB03x
</span><span class="line">Content-Disposition: form-data; name="submit-name"
</span><span class="line">
</span><span class="line">Larry
</span><span class="line">--AaB03x
</span><span class="line">Content-Disposition: form-data; name="files"; filename="file1.txt"
</span><span class="line">Content-Type: text/plain
</span><span class="line">
</span><span class="line">... contents of file1.txt ...
</span><span class="line">--AaB03x--</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>上面 ‘boundary’ 的值，就与常见的 ‘application/x-www-form-urlencoded’ 中 ‘&amp;’ 的作用差不多了，在接收请求的服务器中，会将 body 以 ‘–AaB03x’ 分割出一个个 part，就能正常解析出参数类型，名称，文件名等等内容了。</p>

<h1 id="section">参考资料</h1>

<ul>
  <li><a href="http://www.w3.org/Protocols/rfc1341/7_2_Multipart.html">The Multipart Content-Type</a></li>
  <li><a href="http://www.w3.org/TR/html401/interact/forms.html">Forms</a></li>
  <li><a href="http://stackoverflow.com/questions/4007969/application-x-www-form-urlencoded-or-multipart-form-data">application/x-www-form-urlencoded or multipart/form-data?</a></li>
</ul>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-12-21T11:16:00+08:00" pubdate data-updated="true">2014.12.21</time></div>
	<div class="tags">


	<a class='category' href='/blog/blog/categories/http/'>http</a>, <a class='category' href='/blog/blog/categories/multipart/'>multipart</a>, <a class='category' href='/blog/blog/categories/restful/'>restful</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/blog/2014/11/27/sort-de-cuo-wu-yong-fa/">Sort 的错误用法</a></h1>
	<div class="entry-content">
		<p>前不久同事的代码中出了一个很神奇的问题，大致流程是对一个由对象组成的数组进行排序，其中属性 a 用于排序，属性 b 作为一个优选条件，当 b 等于 1 的时候无论 a 值是什么，都排在开头 。这本是一个很简单的问题，问题就在于他用两次 sort 实现在这次排序，先根据 a 的属性排序，然后再根据 b 的值来排序。问题就出在第二次排序中。</p>

<p>我们想当然的会认为在第一次排序中，数组已经根据 a 的属性由大到小排序，在第二次中我们只要不去动原数组的顺序就行（一般在方法中写成返回0或-1），只考虑单独把 b 等于 1 的元素提到前面去。但是其实这与语言所选用的排序算法有关，javascript （和一起其他语言）内置的 sort 方法采用的是几种排序算法的集合，有时并不能保证相同元素的位置保持一致。</p>

<p>下面是从 <a href="http://stackoverflow.com/questions/27071942/array-sort-is-producing-unexpected-results-when-elements-are-equal">stackoverflow</a> 上面找来的一个例子</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kd">var</span> <span class="nx">arrayToSort</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">  <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
</span><span class="line">  <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
</span><span class="line">  <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;j&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
</span><span class="line">  <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
</span><span class="line">  <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="nx">strength</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>
</span><span class="line"><span class="p">];</span>
</span><span class="line">
</span><span class="line"><span class="nx">arrayToSort</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">strength</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">strength</span><span class="p">;</span>
</span><span class="line"><span class="p">});</span>
</span><span class="line">
</span><span class="line"><span class="nx">arrayToSort</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
</span><span class="line"><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>我们会以为最后元素的值还是从 a 到 t，但实际运行下来的结果却是乱序的，这是因为 sort 的算法并没有保留原数组的顺序，也即 <a href="http://www.ecma-international.org/ecma-262/5.1/#sec-15.4.4.11">unstable</a>。</p>

<p>那么我们就该尽量避免这种情况发生，就我同事的例子，将两次 sort 的逻辑合并在一次中应该是个可行的办法，如果必须分为多次 sort，那么就把原数组的顺序记录在元素的属性上把。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-11-27T14:07:00+08:00" pubdate data-updated="true">2014.11.27</time></div>
	<div class="tags">


	<a class='category' href='/blog/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/blog/categories/sort/'>sort</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/blog/2014/11/23/yong-heredoc-xie-mongo-shell/">用 Heredoc 写 Mongo Shell</a></h1>
	<div class="entry-content">
		<p>mongo shell 给我们提供了很便捷的 mongodb 操作接口，很多人应该用过 <code>mongo</code> 命令执行 javascript 文件，或者通过 <code>mongo --eval</code> 执行脚本。两种方式各有千秋，使用 js 文件可编辑较复杂的代码逻辑，而且可以作为脚本储存以备重复使用。使用 <code>mongo --eval</code> 比较灵活，随取随用，但是当代码中有换行时，就蛋疼了。mongo <a href="http://docs.mongodb.org/v2.6/administration/scripting/">官方的文档</a> 并没有提到 eval 在处理多行代码时的解决方案，好在最近发现用 heredoc 可以完美的解决这个问题。</p>

<h1 id="heredoc">heredoc</h1>

<p>heredoc 在 <a href="http://en.wikipedia.org/wiki/Here_document">wiki</a> 上解释为一段可被当做独立文件的代码片段，一般表现为下面这种形式：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">tr a-z A-Z <span class="s">&lt;&lt;END_TEXT</span>
</span><span class="line"><span class="s">one two three</span>
</span><span class="line"><span class="s">uno dos tres</span>
</span><span class="line"><span class="s">END_TEXT</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这里的 <code>&lt;&lt;END_TEXT</code> 到 <code>END_TEXT</code> 就是 heredoc 了，虽然语法简单，用处可就大了。在这里正好解决了在 <code>mongo --eval</code> 中遇到的问题，由于这段字符串可被当成文件来使用，所以直接跟在 <code>mongo</code> 命令后面就行</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">mongo localhost/test <span class="s">&lt;&lt;MONGO</span>
</span><span class="line"><span class="s">db.users.save({name: &quot;mongo&quot;})</span>
</span><span class="line"><span class="s">MONGO</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>在编写 <a href="https://github.com/sailxjx/mms">mms</a> 这个迁移模块的时候，如果没有 heredoc，则不免需要生成一些 js 临时文件来给 mongo 执行，现在，<a href="https://github.com/sailxjx/mms/blob/master/src/mongo.coffee">直接拼接成字符串就行</a>。</p>

<p>最后，使用中不要忘了将一些字符转义掉，比如 ‘$’，以免被当成 shell 变量引用了。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-11-23T12:24:00+08:00" pubdate data-updated="true">2014.11.23</time></div>
	<div class="tags">


	<a class='category' href='/blog/blog/categories/heredoc/'>heredoc</a>, <a class='category' href='/blog/blog/categories/mongo/'>mongo</a>, <a class='category' href='/blog/blog/categories/shell/'>shell</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/blog/2014/10/10/li-yong-nginx-shi-xian-jing-tai-zi-yuan-de-fan-xiang-dai-li/">利用 Nginx 实现静态资源的反向代理</a></h1>
	<div class="entry-content">
		<p>github 中很多项目都有一个 readme 文件，很多人喜欢在文件中添加自己的创作或封面图片，比如 <a href="https://github.com/substack">substack</a> 为他的每个项目绘制了一个 logo。这些图片在 github 中能直接在页面中显示出来，不过 url 被替换成了 github 自己的。比如在 <a href="https://github.com/substack/node-browserify/blob/master/readme.markdown">browserify</a> 项目中，logo 的链接变成了</p>

<blockquote>
  <p>https://camo.githubusercontent.com/e19e230a9371a44a2eeb484b83ff4fcf8c824cf7/687474703a2f2f737562737461636b2e6e65742f696d616765732f62726f777365726966795f6c6f676f2e706e67</p>
</blockquote>

<p>而我们通过查看 <a href="https://raw.githubusercontent.com/substack/node-browserify/master/readme.markdown">raw</a> 能发现原 url 是</p>

<blockquote>
  <p>http://substack.net/images/browserify_logo.png</p>
</blockquote>

<p>这样做的一个好处是防止因为在 https 网站中出现 http 链接，否则在客户端会得到一个风险警告。github 在细节上真是考虑的十分周到。</p>

<p>既然有需求，我们就来实现它。通常的做法是写一个应用去抓取远程的静态资源，然后反馈给前端，这就是一个简单地反向代理了。但是这样做比较繁琐，效率也未见得高，其实我们可以直接通过 nginx 来代理这些静态文件。</p>

<p>nginx 的 <code>proxy_pass</code> 支持填写任意地址，并且支持 dns 解析。所以我的思路是，将原 url 加密转成网站自身的 url。比如上面的</p>

<blockquote>
  <p>http://substack.net/images/browserify_logo.png</p>
</blockquote>

<p>可以加密成</p>

<blockquote>
  <p>764feebffb1d3f877e9e0d0fadcf29b85e8fe84ae4ce52f7dc4ca4b3e05bf1718177870a996fe5804a232fcae5b893ea (加密和序列化算法网上有很多，在此就不赘述了)</p>
</blockquote>

<p>然后放在我们自己的域名下：</p>

<blockquote>
  <p>https://ssl.youdomain.com/camo/764feebffb1d3f877e9e0d0fadcf29b85e8fe84ae4ce52f7dc4ca4b3e05bf1718177870a996fe5804a232fcae5b893ea</p>
</blockquote>

<p>解密的步骤用 nginx 会比较难实现，所以当用户通过上述链接请求时，先讲请求传递给解密程序，这里有一个 coffeescript 版本的例子：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nv">express = </span><span class="nx">require</span> <span class="s">&#39;express&#39;</span>
</span><span class="line"><span class="nv">app = </span><span class="nx">express</span><span class="p">()</span>
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/camo/:eurl&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
</span><span class="line">  <span class="p">{</span><span class="nx">eurl</span><span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span>
</span><span class="line">  <span class="p">{</span><span class="nx">camoSecret</span><span class="p">}</span> <span class="o">=</span> <span class="nx">config</span>  <span class="c1"># 这里使用自己的密钥</span>
</span><span class="line">  <span class="nv">rawUrl = </span><span class="nx">util</span><span class="p">.</span><span class="nx">decrypt</span> <span class="nx">eurl</span><span class="p">,</span> <span class="nx">camoSecret</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">end</span><span class="p">(</span><span class="s">&#39;INVALID URL&#39;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">rawUrl</span>
</span><span class="line">  <span class="nx">res</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;X-Origin-Url&#39;</span><span class="p">,</span> <span class="nx">rawUrl</span>
</span><span class="line">  <span class="nx">res</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;X-Accel-Redirect&#39;</span><span class="p">,</span> <span class="s">&#39;/remote&#39;</span>
</span><span class="line">  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span> <span class="mi">3000</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>然后写入 <code>X-Accel-Redirect</code> 响应头做内部跳转，下面的步骤就由 nginx 完成了。</p>

<p>下面是一个完整的 nginx 配置文件例子：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="nginx"><span class="line"><span class="k">server</span> <span class="p">{</span>
</span><span class="line">    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span><span class="line">    <span class="kn">server_name</span> <span class="s">ssl.youdomain.com</span><span class="p">;</span>
</span><span class="line">    <span class="kn">location</span> <span class="s">/camo/</span> <span class="p">{</span>
</span><span class="line">        <span class="kn">proxy_pass</span> <span class="s">http://localhost:3000</span><span class="p">;</span>
</span><span class="line">        <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class="line">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class="line">        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
</span><span class="line">        <span class="kn">proxy_set_header</span> <span class="s">X-NginX-Proxy</span> <span class="s">true</span><span class="p">;</span>
</span><span class="line">        <span class="kn">proxy_http_version</span> <span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
</span><span class="line">        <span class="kn">proxy_set_header</span> <span class="s">Upgrade</span> <span class="nv">$http_upgrade</span><span class="p">;</span>
</span><span class="line">        <span class="kn">proxy_set_header</span> <span class="s">Connection</span> <span class="s">&quot;Upgrade&quot;</span><span class="p">;</span>
</span><span class="line">        <span class="kn">proxy_redirect</span> <span class="no">off</span><span class="p">;</span>
</span><span class="line">        <span class="kn">break</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="kn">location</span> <span class="s">/remote</span> <span class="p">{</span>
</span><span class="line">        <span class="kn">internal</span><span class="p">;</span>
</span><span class="line">        <span class="kn">resolver</span> <span class="mi">192</span><span class="s">.168.0.21</span><span class="p">;</span>  <span class="c1"># 必须加上 dns 服务器地址，否则 nginx 无法解析域名</span>
</span><span class="line">        <span class="kn">set</span> <span class="nv">$origin_url</span> <span class="nv">$upstream_http_x_origin_url</span><span class="p">;</span>
</span><span class="line">        <span class="kn">proxy_pass</span> <span class="nv">$origin_url</span><span class="p">;</span>
</span><span class="line">        <span class="kn">add_header</span> <span class="s">Host</span> <span class="s">&quot;file.local.com&quot;</span><span class="p">;</span>
</span><span class="line">        <span class="kn">break</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>nginx 的 upstream 模块会把所有的响应头加上 <code>$upstream_http_</code> 前缀当成一个变量保存，所以在上面的例子中我们将原 url 放在 <code>X-Origin-Url</code> 响应头中，在 nginx 就变成了 <code>$upstream_http_x_origin_url</code> 变量，但是在 proxy_pass 中不能直接引用，非要通过 set 来设置才能引用，这个我不是很理解，希望有高手能解答。</p>

<p>这样下来，每次当用户请求</p>

<blockquote>
  <p>https://ssl.youdomain.com/camo/764feebffb1d3f877e9e0d0fadcf29b85e8fe84ae4ce52f7dc4ca4b3e05bf1718177870a996fe5804a232fcae5b893ea</p>
</blockquote>

<p>时，nginx 就会去抓取</p>

<blockquote>
  <p>http://substack.net/images/browserify_logo.png</p>
</blockquote>

<p>的内容返回给用户。我们还可以在 nginx 之前加上 varnish，用以缓存静态文件的内容。这样就跟 githubusercontent 的做法更加一致了。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-10-10T16:52:00+08:00" pubdate data-updated="true">2014.10.10</time></div>
	<div class="tags">


	<a class='category' href='/blog/blog/categories/nginx/'>nginx</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/blog/2014/09/13/yi-ci-shen-qi-de-nodejs-debug-jing-li/">一次神奇的 Nodejs Debug 经历</a></h1>
	<div class="entry-content">
		<p>中秋之后，服务器上老是出现 cpu 爆满的情况，难道服务器也闹情绪想休假。当然这种情况是很紧急的，所以马上就着手排查。</p>

<p>还没找出问题，又有同学报测试机上也有这种情况，但是应用进程不同。想到有可能这两件事是有关联的，所以先从测试机开始排查。</p>

<h2 id="settimeout--bug">问题一， setTimeout 的 bug</h2>

<p>测试机上的问题很好排查，每次进程重启后立刻飙升到 100%，通过万能的 log 大法，很快就定位到问题。应用中使用了 <a href="https://github.com/visionmedia/axon">axon</a> 模块作为消息中间件，在连接不成功时会用 <code>setTimeout</code> 尝试重连，间隔由最初的 100ms 开始每次乘以 1.5，这样在三次之后间隔就变成了 337.5ms，nodejs 有<a href="https://github.com/joyent/node/issues/5796">一个 bug</a>，Timer 函数中出现小数时会导致死循环，我们用的是 0.10.30 版本，这个 bug 依然可以重现。所以解决办法也很简单了，直接 <a href="https://github.com/visionmedia/axon/commit/68a23cacd5fd94527b52738b0d43876187ee82e9#diff-595746af128d06d3cac45cb001ad2219R280">round 一下</a>就可以了。以后在使用 Timer 类函数时也需要注意不要出现小数哦。</p>

<h2 id="section">问题二，正则表达式的效率问题</h2>

<p>由于 axon 在生产环境中也有使用，我们就将所有的版本都进行了升级，以为万事大吉。结果却不遂人愿，生产环境中的几个进程在启动后，时不时会出现负载 100% 的情况，这种可能性分析起来就很复杂了。我们依次尝试了 node-inspector，node-heapdump 等工具，都没有找到原因（实话说，以前用这些 debug 内存问题时也是一无所获，nodejs 的 debug 工具实在鸡肋）。也没有重现线上的问题。</p>

<p>一个有趣的现象是，我发现每次进程重启之后，飙升到 100% 的时间不定，但是每次都是瞬间从 0 到 100%。这种现象说明导致问题的原因可能不是程序内部产生，而是由外力产生，这个外力是什么呢，其实就是请求。再一次借助万能 log 大法，express 的 log 只能记录有响应的请求，如果一个请求在中途陷入了死循环，那么就得不到 express 的 log，所以我们自己写了一个中间件，在 express 的最前部引入，只打印出请求的链接。</p>

<p>接下来问题就很明显了（其实也破费一番周折），每当出现某一请求时，程序就陷入了死循环，屡试不爽。一步步排查下来，发现问题出现在 <a href="https://github.com/leizongmin/js-xss">xss</a> 模块中，其中的一个正则表达式，在匹配某些字符串时出现了问题：</p>

<ul>
  <li>表达式：<code>/&lt;!--(.|\s)*?--&gt;/gm</code></li>
  <li>测试字符串：<code>&lt;!--                                    </code></li>
</ul>

<p>当表达式未找到匹配内容时，效率指数级的下降，特别是在多个重复空格和子表达式时。这个原因解释起来就比较复杂了。<a href="http://swtch.com/~rsc/regexp/regexp1.html">大神的一篇文章</a>很好的解释了这个问题，有时间我要翻译一下，一定又有很多收获。</p>

<p>解决的方法很简单，在<a href="https://github.com/leizongmin/js-xss/commit/161f9510aab78aba83cf75c54c0dafd3a0436a84#diff-666d669efc2fef279da605aba853e681L354">这个 Pull Request</a>中可以找到。看来以后使用正则表达式的时候得过留个心眼了。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-09-13T18:09:00+08:00" pubdate data-updated="true">2014.09.13</time></div>
	<div class="tags">


	<a class='category' href='/blog/blog/categories/debug/'>debug</a>, <a class='category' href='/blog/blog/categories/nodejs/'>nodejs</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/blog/2014/08/28/limbo-jian-dan-fang-wen-yuan-cheng-shu-ju-ku/">Limbo: 简单访问远程数据库</a></h1>
	<div class="entry-content">
		<p><img src="https://dn-talk.oss.aliyuncs.com/site/images/workspace-c16d9d49.jpg" alt="简聊一下 轻松协作" /></p>

<p>对于 nodejs 生态来说，使用 mongoose 作为 Model 模块是再好不过的一件事，其一大特点就是简洁优雅的 Schema 定义，提供了每个键值的类型验证，数据验证，索引声明，虚拟键，并自带实例化方法的扩展，大大节省了开发的成本。但是在考虑开放数据的时候，一切就显得不那么美好了。</p>

<p>在打造<a href="https://talk.ai/">简聊</a>这款应用的过程中，我们就实实在在的遇到了这样的问题。由于需要使用 <a href="https://www.teambition.com/">Teambition</a> 的用户和团队数据，并且当<a href="https://talk.ai/">简聊</a>更新了用户数据之后，在 <a href="https://www.teambition.com/">Teambition</a> 中能实时的将这些更新推送到用户那里。按照惯例，我们最初使用的是 restful 接口。</p>

<h2 id="restful-">第一阶段，使用 restful 接口</h2>

<p>restful 接口的应用面最广，但是仍然存在很多不足，比如接口在参数和结构上限制较多，在考虑修改接口 api 的时候，往往会顾虑客户端的兼容性，而一旦客户端程序有新的需求，则需等待接口的更新。另一个麻烦的地方是需要做签名校验，对于内部的应用来说，我们完全可以通过防火墙来控制特定 ip 对端口的访问，签名在此处就显得有点多余。</p>

<h2 id="schema">第二阶段，单独拆封 Schema</h2>

<p>然后我们想到了将 Schema 拆封成一个单独的仓库，nodejs 有良好的模块管理，在不同的应用中，我们只需要将这些模块引入进来，既做到同步更新，又做到 DRY。相对于 restful 接口的缺点就是，对于数据的调用入口过多，而且应用之间互相是不知情的。例如在<a href="https://talk.ai/">简聊</a>中有更新用户数据，在 <a href="https://www.teambition.com">Teambition</a> 中就无法得知，并推送给其他客户端。</p>

<h2 id="rpc">第三阶段，远程过程调用（rpc）</h2>

<p>这个阶段和 restful 接口其实类似，我们在 <a href="https://www.teambition.com">Teambition</a>  的后端进程中将一些接口方法暴露出来，这样我们的客户端程序就能通过简单的 rpc 方式调用这些接口。例如我们导出了 <code>user.update</code> 方法，在客户端代码中使用 <code>rpc.call('user.update', params, callback)</code> 即可调用相应的过程。这样的调用行为与使用本地代码无异，可能是目前能找到的最简单直接的方式了。</p>

<h2 id="rpc--mongoose-">第四阶段，rpc 与 mongoose 的结合</h2>

<p>事情可以变得更简单，由于目的主要是为了操作数据库，所以我们开发了一个模块 <a href="https://github.com/teambition/limbo">limbo</a>，将 mongoose model 中所有方法暴露出来，以命名空间来划分，实现了在客户端与服务端程序一致的使用体验。</p>

<p>例如我们在服务端程序中使用 limbo 连接 mongodb，只需要做如下声明：（以下的代码都以 coffeescript 作为示例）</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nv">limbo = </span><span class="nx">require</span> <span class="s">&#39;limbo&#39;</span>
</span><span class="line">
</span><span class="line"><span class="c1"># 定义 Schema</span>
</span><span class="line"><span class="nv">UserSchame = </span><span class="nf">(Schema) -&gt;</span>
</span><span class="line">  <span class="c1"># 这里的 Schema 即 mongoose.Schema</span>
</span><span class="line">  <span class="k">new</span> <span class="nx">Schema</span>
</span><span class="line">    <span class="nv">name: </span><span class="nb">String</span>
</span><span class="line">    <span class="nv">email: </span><span class="nb">String</span>
</span><span class="line">
</span><span class="line"><span class="c1"># use 方法用作区分不同数据库连接的命名空间，一般参数选择数据库名就行</span>
</span><span class="line"><span class="nv">db = </span><span class="nx">limbo</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">).</span><span class="nx">connect</span><span class="p">(</span><span class="s">&#39;mongodb://localhost:27017/test&#39;</span><span class="p">).</span><span class="nx">load</span> <span class="s">&#39;User&#39;</span><span class="p">,</span> <span class="nx">UserSchema</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>使用方式就与 mongoose 一致了</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nv">user = </span><span class="nx">db</span><span class="p">.</span><span class="nx">user</span>
</span><span class="line"><span class="c1"># user 是一个 limbo 中用于封装 model 的一个对象，你可以直接使用 user.model 来直接调用 mongoose model</span>
</span><span class="line"><span class="nx">user</span><span class="p">.</span><span class="nx">findOne</span> <span class="nv">_id: </span><span class="s">&#39;xxxx&#39;</span>
</span><span class="line"><span class="nx">user</span><span class="p">.</span><span class="nx">create</span> <span class="nv">name: </span><span class="s">&#39;xxx&#39;</span><span class="p">,</span> <span class="nv">email: </span><span class="s">&#39;yyy&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>下面是 limbo 中最激动人心的地方，你可以导出一个 collection 中的所有方法到 rpc server 中，只需要通过一个简单的声明</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nx">limbo</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="mi">7001</span><span class="p">).</span><span class="nx">enableRpc</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>下面我们就要提到如何在客户端程序中调用这些方法</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="c1"># 在客户端也需要初始化一个 limbo 命名空间，需要与服务端一致，链接改为服务端的域名和端口号</span>
</span><span class="line"><span class="nv">db = </span><span class="nx">limbo</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">).</span><span class="nx">connect</span><span class="p">(</span><span class="s">&#39;tcp://localhost:7001&#39;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c1"># 下面有两种方式来使用 rpc</span>
</span><span class="line"><span class="c1"># 1. 使用 call 方法</span>
</span><span class="line"><span class="nx">db</span><span class="p">.</span><span class="nx">call</span> <span class="s">&#39;user.findOne&#39;</span><span class="p">,</span> <span class="nv">_id: </span><span class="s">&#39;xxxx&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
</span><span class="line"><span class="c1"># 2. 使用方法链</span>
</span><span class="line"><span class="nx">db</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">findOne</span> <span class="nv">_id: </span><span class="s">&#39;xxxx&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
</span><span class="line"><span class="c1"># 第二种方式存在一个延迟，必须要在 limbo 与服务端程序握手成功之后才可以使用，</span>
</span><span class="line"><span class="c1"># 否则会抛出一个对象不存在的异常，不过在一般的应用中，</span>
</span><span class="line"><span class="c1"># 初始化所需的时间都会长于这个链接所需时间，所以延迟可以忽略不计了</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>可以看出，上面的第二种方式与服务端在本地使用 mongoose 的方式一模一样，这种黑魔法式的调用方式应该是广大码农喜闻乐见的。</p>

<p>limbo 另一个值得称道的功能是可以在服务端程序监听这些远程调用的事件，这得益于 nodejs 的 event 对象，limbo 本身就继承于 EventEmitter 对象，所以我们在每次远程调用后会触发一个事件给服务端程序，而在服务端只需要简单的监听这个事件即可</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nx">limbo</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;test.user.findOne&#39;</span><span class="p">,</span> <span class="nf">(user) -&gt;</span> <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>正是这种 rpc 加事件反馈的机制，让<a href="https://talk.ai/">简聊</a>和 <a href="https://www.teambition.com">Teambition</a> 可以实现简单实时的数据交换。我们将 <a href="https://github.com/teambition/limbo">limbo</a> 托管在 github 上开源，是深知它还存在很多可以改进的地方，所以不免庸俗的说一句，欢迎 issue 和 pr~</p>

<p>最后，欢迎访问我们的新产品<a href="https://talk.ai">简聊</a>，一款基于话题的轻量级协作应用。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-08-28T17:41:00+08:00" pubdate data-updated="true">2014.08.28</time></div>
	<div class="tags">


	<a class='category' href='/blog/blog/categories/database/'>database</a>, <a class='category' href='/blog/blog/categories/mongodb/'>mongodb</a>, <a class='category' href='/blog/blog/categories/mongoose/'>mongoose</a>, <a class='category' href='/blog/blog/categories/nodejs/'>nodejs</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/blog/2014/08/09/gei-github-page-she-zhi-yu-ming/">给 Github Page 设置域名</a></h1>
	<div class="entry-content">
		<p>Github 免费提供了很棒的静态站托管服务 <a href="https://pages.github.com/">github pages</a>，并且为每人准备了一个二级域名 username.github.io。</p>

<p>但是对于喜欢个性又爱折腾的码农来说，使用别人的域名，是万万不能忍受滴，所以 github 支持了绑定个人域名。</p>

<p>英语不错的可直接传送官方文档 <a href="https://help.github.com/articles/setting-up-a-custom-domain-with-github-pages">Tips for configuring a CNAME record with your DNS provider</a>，如我这样记性不好的，就看下面的流程：</p>

<p>首先，你得有个自己的域名，比如这个 jingxin.me，然后我的目标是绑定到 sailxjx.github.io，并支持所有二级域名的跳转，如从 sailxjx.github.io/blog 会自动转到 jingxin.me/blog。</p>

<p>然后，我们要创建 CNAME 记录，这一步要在个人域名托管的 dns 服务上操作，添加一条 CNAME 记录，指向 sailxjx.github.io，这样，就实现了通过 jingxin.me 访问 github page 内容的目的。通过 dig 命令可以查看是否生效，这个时候如果你用 ping 或者 nslookup 会看到两个域名的 ip 是一样的。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class=""><span class="line">$ dig jingxin.me +nostats +nocomments +nocmd
</span><span class="line">;jingxin.me.                  IN  A
</span><span class="line">jingxin.me.             346   IN  CNAME sailxjx.github.io.
</span><span class="line">sailxjx.github.io.      3346  IN  CNAME github.map.fastly.net.
</span><span class="line">github.map.fastly.net.  46    IN  A 103.245.222.133</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>最后，当然是告诉 github 需要自动从 sailxjx.github.io 跳转到 jingxin.me，是需要在相关的 repository 中添加一个 CNAME 文件，里面保留一行域名记录（不包含 http 等 schema 部分），比如<a href="https://github.com/sailxjx/sailxjx.github.com/blob/master/CNAME">这里</a>，push 之后就可以在项目的设置中看到这样的提示</p>

<p><img src="https://github-images.s3.amazonaws.com/help/settings/pages-section.png" alt="pages-section.png" /></p>

<p>下面就是短暂的等待了，快的话立即就生效了。</p>

<h2 id="section">多余的话</h2>

<p>除了使用 CNAME，github 还提供了另一种做法 <a href="https://help.github.com/articles/about-custom-domains-for-github-pages-sites#apex-domains">Apex domains</a>，由于官方并不推荐，所以这里也就不介绍了。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-08-09T18:28:00+08:00" pubdate data-updated="true">2014.08.09</time></div>
	<div class="tags">


	<a class='category' href='/blog/blog/categories/domain/'>domain</a>, <a class='category' href='/blog/blog/categories/github/'>github</a>, <a class='category' href='/blog/blog/categories/page/'>page</a>, <a class='category' href='/blog/blog/categories/server/'>server</a>


</div>
	
</div></article>

<nav id="pagenavi">
    
    
        <a href="/blog/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    Xu Jingxin

</footer>
	<script src="/blog/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'sailxjx';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


<script id="gta-main" src="/blog/javascripts/gta.js", data-baidu="43f786342ba0680af108248b28280fdb", data-google="UA-33186961-1", data-mixpanel="204d761f0c52d9ddcf031ec634f98772"></script>
<!-- mixpanel pageview -->
<script>
  mixpanel.track("pageview: " + document.URL);
</script>



</body>
</html>